<#
.SYNOPSIS
  Windows GUI for UDP Jitter Optimization (Apply, Backup, Restore, Reset).

.DESCRIPTION
  Launches a Windows Forms GUI that calls the WindowsUdpJitterOptimization module.
  Run PowerShell as Administrator for Apply/Backup/Restore/Reset to succeed.
  Windows only.

.NOTES
  Author: Sebastian J. Spicker
  License: MIT
#>

#Requires -Version 5.1

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

if (-not ($env:OS -eq 'Windows_NT' -or [Environment]::OSVersion.Platform -eq 'Win32NT')) {
  Write-Error 'This GUI runs on Windows only.'
  exit 1
}

Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

$script:ModuleLoaded = $false
$script:IsRunInProgress = $false
# Fallback when module not loaded; otherwise use Get-UjDefaultBackupFolder after load (see Form_Load)
$defaultBackupFolder = Join-Path -Path (if ([string]::IsNullOrWhiteSpace($env:ProgramData)) { 'C:\ProgramData' } else { $env:ProgramData }) -ChildPath 'UDPTune'

function Import-UjModuleOnce {
  [CmdletBinding()]
  [OutputType([bool])]
  param()

  if ($script:ModuleLoaded) { return $true }
  try {
    $manifestPath = Join-Path -Path $PSScriptRoot -ChildPath 'WindowsUdpJitterOptimization/WindowsUdpJitterOptimization.psd1'
    if (-not (Test-Path -LiteralPath $manifestPath)) {
      return $false
    }
    Import-Module -Name $manifestPath -Force -ErrorAction Stop
    $script:ModuleLoaded = $true
    return $true
  } catch {
    return $false
  }
}

function Show-UjValidationMessage {
  param([Parameter(Mandatory)][string]$Message)
  [System.Windows.Forms.MessageBox]::Show($Message, 'Validation', [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Warning) | Out-Null
}

$form = New-Object System.Windows.Forms.Form
$form.Text = 'UDP Jitter Optimization'
$form.Size = New-Object System.Drawing.Size(620, 620)
$form.MinimumSize = New-Object System.Drawing.Size(600, 520)
$form.StartPosition = 'CenterScreen'
$form.FormBorderStyle = 'Sizable'

$y = 12
$labelHeight = 20
$rowHeight = 28

# Action
$lblAction = New-Object System.Windows.Forms.Label
$lblAction.Location = New-Object System.Drawing.Point(12, $y)
$lblAction.Size = New-Object System.Drawing.Size(80, $labelHeight)
$lblAction.Text = 'Action:'
$form.Controls.Add($lblAction)
$comboAction = New-Object System.Windows.Forms.ComboBox
$comboAction.Location = New-Object System.Drawing.Point(100, $y - 2)
$comboAction.Size = New-Object System.Drawing.Size(180, 24)
$comboAction.DropDownStyle = 'DropDownList'
@('Apply', 'Backup', 'Restore', 'ResetDefaults') | ForEach-Object { [void]$comboAction.Items.Add($_) }
$comboAction.SelectedIndex = 0
$form.Controls.Add($comboAction)
$y += $rowHeight

# Preset (for Apply)
$lblPreset = New-Object System.Windows.Forms.Label
$lblPreset.Location = New-Object System.Drawing.Point(12, $y)
$lblPreset.Size = New-Object System.Drawing.Size(80, $labelHeight)
$lblPreset.Text = 'Preset:'
$form.Controls.Add($lblPreset)
$comboPreset = New-Object System.Windows.Forms.ComboBox
$comboPreset.Location = New-Object System.Drawing.Point(100, $y - 2)
$comboPreset.Size = New-Object System.Drawing.Size(80, 24)
$comboPreset.DropDownStyle = 'DropDownList'
@(1, 2, 3) | ForEach-Object { [void]$comboPreset.Items.Add($_) }
$comboPreset.SelectedIndex = 0
$form.Controls.Add($comboPreset)
$y += $rowHeight

# Backup folder
$lblBackup = New-Object System.Windows.Forms.Label
$lblBackup.Location = New-Object System.Drawing.Point(12, $y)
$lblBackup.Size = New-Object System.Drawing.Size(80, $labelHeight)
$lblBackup.Text = 'Backup folder:'
$form.Controls.Add($lblBackup)
$txtBackup = New-Object System.Windows.Forms.TextBox
$txtBackup.Location = New-Object System.Drawing.Point(100, $y - 2)
$txtBackup.Size = New-Object System.Drawing.Size(380, 22)
$txtBackup.Text = $defaultBackupFolder
$form.Controls.Add($txtBackup)
$btnBrowse = New-Object System.Windows.Forms.Button
$btnBrowse.Location = New-Object System.Drawing.Point(488, $y - 3)
$btnBrowse.Size = New-Object System.Drawing.Size(90, 24)
$btnBrowse.Text = 'Browse...'
$form.Controls.Add($btnBrowse)
$y += $rowHeight

# Ports (TeamSpeak, CS2)
$lblPorts = New-Object System.Windows.Forms.Label
$lblPorts.Location = New-Object System.Drawing.Point(12, $y)
$lblPorts.Size = New-Object System.Drawing.Size(80, $labelHeight)
$lblPorts.Text = 'TeamSpeak port:'
$form.Controls.Add($lblPorts)
$txtTeamSpeakPort = New-Object System.Windows.Forms.TextBox
$txtTeamSpeakPort.Location = New-Object System.Drawing.Point(100, $y - 2)
$txtTeamSpeakPort.Size = New-Object System.Drawing.Size(60, 22)
$txtTeamSpeakPort.Text = '9987'
$form.Controls.Add($txtTeamSpeakPort)
$lblCS2 = New-Object System.Windows.Forms.Label
$lblCS2.Location = New-Object System.Drawing.Point(180, $y)
$lblCS2.Size = New-Object System.Drawing.Size(120, $labelHeight)
$lblCS2.Text = 'CS2 ports (start-end):'
$form.Controls.Add($lblCS2)
$txtCS2Start = New-Object System.Windows.Forms.TextBox
$txtCS2Start.Location = New-Object System.Drawing.Point(300, $y - 2)
$txtCS2Start.Size = New-Object System.Drawing.Size(50, 22)
$txtCS2Start.Text = '27015'
$form.Controls.Add($txtCS2Start)
$txtCS2End = New-Object System.Windows.Forms.TextBox
$txtCS2End.Location = New-Object System.Drawing.Point(358, $y - 2)
$txtCS2End.Size = New-Object System.Drawing.Size(50, 22)
$txtCS2End.Text = '27036'
$form.Controls.Add($txtCS2End)
$y += $rowHeight

# Power plan
$lblPower = New-Object System.Windows.Forms.Label
$lblPower.Location = New-Object System.Drawing.Point(12, $y)
$lblPower.Size = New-Object System.Drawing.Size(80, $labelHeight)
$lblPower.Text = 'Power plan:'
$form.Controls.Add($lblPower)
$comboPowerPlan = New-Object System.Windows.Forms.ComboBox
$comboPowerPlan.Location = New-Object System.Drawing.Point(100, $y - 2)
$comboPowerPlan.Size = New-Object System.Drawing.Size(120, 24)
$comboPowerPlan.DropDownStyle = 'DropDownList'
@('None', 'HighPerformance', 'Ultimate') | ForEach-Object { [void]$comboPowerPlan.Items.Add($_) }
$comboPowerPlan.SelectedIndex = 0
$form.Controls.Add($comboPowerPlan)
$lblAfd = New-Object System.Windows.Forms.Label
$lblAfd.Location = New-Object System.Drawing.Point(230, $y)
$lblAfd.Size = New-Object System.Drawing.Size(90, $labelHeight)
$lblAfd.Text = 'AFD threshold:'
$form.Controls.Add($lblAfd)
$txtAfdThreshold = New-Object System.Windows.Forms.TextBox
$txtAfdThreshold.Location = New-Object System.Drawing.Point(322, $y - 2)
$txtAfdThreshold.Size = New-Object System.Drawing.Size(60, 22)
$txtAfdThreshold.Text = '1500'
$form.Controls.Add($txtAfdThreshold)
$y += $rowHeight

# Checkboxes
$chkDryRun = New-Object System.Windows.Forms.CheckBox
$chkDryRun.Location = New-Object System.Drawing.Point(12, $y)
$chkDryRun.Size = New-Object System.Drawing.Size(200, 22)
$chkDryRun.Text = 'Preview only (DryRun, no changes)'
$form.Controls.Add($chkDryRun)
$chkDisableGameDvr = New-Object System.Windows.Forms.CheckBox
$chkDisableGameDvr.Location = New-Object System.Drawing.Point(220, $y)
$chkDisableGameDvr.Size = New-Object System.Drawing.Size(160, 22)
$chkDisableGameDvr.Text = 'Disable Game DVR'
$form.Controls.Add($chkDisableGameDvr)
$chkDisableUro = New-Object System.Windows.Forms.CheckBox
$chkDisableUro.Location = New-Object System.Drawing.Point(388, $y)
$chkDisableUro.Size = New-Object System.Drawing.Size(120, 22)
$chkDisableUro.Text = 'Disable URO'
$form.Controls.Add($chkDisableUro)
$y += $rowHeight

# Include app-based QoS policies
$chkIncludeAppPolicies = New-Object System.Windows.Forms.CheckBox
$chkIncludeAppPolicies.Location = New-Object System.Drawing.Point(12, $y)
$chkIncludeAppPolicies.Size = New-Object System.Drawing.Size(220, 22)
$chkIncludeAppPolicies.Text = 'Include app-based QoS policies'
$form.Controls.Add($chkIncludeAppPolicies)
$y += $rowHeight
$lblAppPaths = New-Object System.Windows.Forms.Label
$lblAppPaths.Location = New-Object System.Drawing.Point(12, $y)
$lblAppPaths.Size = New-Object System.Drawing.Size(80, $labelHeight)
$lblAppPaths.Text = 'App paths (one per line):'
$form.Controls.Add($lblAppPaths)
$y += $labelHeight
$txtAppPaths = New-Object System.Windows.Forms.TextBox
$txtAppPaths.Location = New-Object System.Drawing.Point(12, $y)
$txtAppPaths.Multiline = $true
$txtAppPaths.Size = New-Object System.Drawing.Size(566, 44)
$txtAppPaths.ScrollBars = 'Vertical'
$form.Controls.Add($txtAppPaths)
$y += 50

# Admin hint (set in Form_Load after module load so Test-UjIsAdministrator is available)
$lblAdmin = New-Object System.Windows.Forms.Label
$lblAdmin.Location = New-Object System.Drawing.Point(12, $y)
$lblAdmin.AutoSize = $true
$lblAdmin.Text = 'Loading...'
$form.Controls.Add($lblAdmin)
$y += $labelHeight + 6

# Run button
$btnRun = New-Object System.Windows.Forms.Button
$btnRun.Location = New-Object System.Drawing.Point(12, $y)
$btnRun.Size = New-Object System.Drawing.Size(100, 28)
$btnRun.Text = 'Run'
$form.Controls.Add($btnRun)
$y += 36

# Log area
$lblLog = New-Object System.Windows.Forms.Label
$lblLog.Location = New-Object System.Drawing.Point(12, $y)
$lblLog.Size = New-Object System.Drawing.Size(200, $labelHeight)
$lblLog.Text = 'Output:'
$form.Controls.Add($lblLog)
$y += $labelHeight
$txtLog = New-Object System.Windows.Forms.TextBox
$txtLog.Location = New-Object System.Drawing.Point(12, $y)
$txtLog.Multiline = $true
$txtLog.ScrollBars = 'Vertical'
$txtLog.ReadOnly = $true
$txtLog.Anchor = [System.Windows.Forms.AnchorStyles]::Top -bor [System.Windows.Forms.AnchorStyles]::Bottom -bor [System.Windows.Forms.AnchorStyles]::Left -bor [System.Windows.Forms.AnchorStyles]::Right
$txtLog.Size = New-Object System.Drawing.Size(566, 220)
$form.Controls.Add($txtLog)

function Add-UjGuiLog {
  param(
    [Parameter(Mandatory)][string]$Phase,
    [Parameter(Mandatory)][string]$Message
  )
  $txtLog.AppendText(("[{0}] {1}`r`n" -f $Phase, $Message))
}

function Resolve-UjGuiRunParameter {
  [CmdletBinding()]
  [OutputType([pscustomobject])]
  param()

  $action = $comboAction.SelectedItem.ToString()
  $backupFolder = $txtBackup.Text.Trim()
  $preset = [int]$comboPreset.SelectedItem

  if ($action -in @('Apply', 'Backup', 'Restore')) {
    if ([string]::IsNullOrWhiteSpace($backupFolder)) {
      Show-UjValidationMessage -Message 'Backup folder is required for this action.'
      return [pscustomobject]@{ IsValid = $false }
    }

    if (Get-Command -Name Test-UjUnsafeBackupFolder -ErrorAction SilentlyContinue) {
      if (Test-UjUnsafeBackupFolder -Path $backupFolder) {
        Show-UjValidationMessage -Message 'Backup folder points to a sensitive system directory. Choose another folder. For intentional override, use CLI with -AllowUnsafeBackupFolder.'
        return [pscustomobject]@{ IsValid = $false }
      }
    }
  }

  $teamSpeakPort = 9987
  $cs2Start = 27015
  $cs2End = 27036
  $afdThreshold = 1500

  if ($action -eq 'Apply') {
    try {
      if (-not [string]::IsNullOrWhiteSpace($txtTeamSpeakPort.Text)) { $teamSpeakPort = [int]$txtTeamSpeakPort.Text }
      if (-not [string]::IsNullOrWhiteSpace($txtCS2Start.Text)) { $cs2Start = [int]$txtCS2Start.Text }
      if (-not [string]::IsNullOrWhiteSpace($txtCS2End.Text)) { $cs2End = [int]$txtCS2End.Text }
    } catch {
      Show-UjValidationMessage -Message 'Ports must be valid numbers (1-65535).'
      return [pscustomobject]@{ IsValid = $false }
    }

    if ($teamSpeakPort -lt 1 -or $teamSpeakPort -gt 65535 -or
        $cs2Start -lt 1 -or $cs2Start -gt 65535 -or
        $cs2End -lt 1 -or $cs2End -gt 65535) {
      Show-UjValidationMessage -Message 'All ports must be between 1 and 65535.'
      return [pscustomobject]@{ IsValid = $false }
    }

    if ($cs2End -lt $cs2Start) {
      Show-UjValidationMessage -Message 'CS2 end port must be >= start port.'
      return [pscustomobject]@{ IsValid = $false }
    }

    try {
      if (-not [string]::IsNullOrWhiteSpace($txtAfdThreshold.Text)) { $afdThreshold = [int]$txtAfdThreshold.Text }
    } catch {
      Show-UjValidationMessage -Message 'AFD threshold must be a number (0-65535).'
      return [pscustomobject]@{ IsValid = $false }
    }

    if ($afdThreshold -lt 0 -or $afdThreshold -gt 65535) {
      Show-UjValidationMessage -Message 'AFD threshold must be between 0 and 65535.'
      return [pscustomobject]@{ IsValid = $false }
    }
  }

  $appPaths = @()
  if ($chkIncludeAppPolicies.Checked -and -not [string]::IsNullOrWhiteSpace($txtAppPaths.Text)) {
    $appPaths = $txtAppPaths.Text -split "`r?`n" | ForEach-Object { $_.Trim() } | Where-Object { -not [string]::IsNullOrWhiteSpace($_) }
  }

  $params = @{
    Action             = $action
    Preset             = $preset
    BackupFolder       = $backupFolder
    TeamSpeakPort      = $teamSpeakPort
    CS2PortStart       = $cs2Start
    CS2PortEnd         = $cs2End
    PowerPlan          = $comboPowerPlan.SelectedItem.ToString()
    DisableGameDvr     = $chkDisableGameDvr.Checked
    DisableUro         = $chkDisableUro.Checked
    DryRun             = $chkDryRun.Checked
    Confirm            = $false
    IncludeAppPolicies = $chkIncludeAppPolicies.Checked
    AppPaths           = $appPaths
    AfdThreshold       = $afdThreshold
  }

  return [pscustomobject]@{
    IsValid = $true
    Params  = $params
    Action  = $action
    Preset  = $preset
  }
}

function Get-UjControlState {
  $action = if ($comboAction.SelectedItem) { $comboAction.SelectedItem.ToString() } else { 'Apply' }
  $isApply = $action -eq 'Apply'
  $needsBackupFolder = $action -in @('Apply', 'Backup', 'Restore')

  foreach ($control in @($lblPreset, $comboPreset, $lblPorts, $txtTeamSpeakPort, $lblCS2, $txtCS2Start, $txtCS2End, $lblPower, $comboPowerPlan, $lblAfd, $txtAfdThreshold, $chkDisableGameDvr, $chkDisableUro, $chkIncludeAppPolicies)) {
    $control.Enabled = $isApply
  }

  $appPathEnabled = $isApply -and $chkIncludeAppPolicies.Checked
  foreach ($control in @($lblAppPaths, $txtAppPaths)) {
    $control.Enabled = $appPathEnabled
  }

  foreach ($control in @($lblBackup, $txtBackup, $btnBrowse)) {
    $control.Enabled = $needsBackupFolder
  }
}

$form.Add_Resize({
  $txtLog.Height = [Math]::Max(100, $form.ClientSize.Height - $y - 12)
})

$form.Add_Load({
  if (Import-UjModuleOnce) {
    try {
      $script:defaultBackupFolder = Get-UjDefaultBackupFolder
      $txtBackup.Text = $script:defaultBackupFolder
    } catch {
      # Keep fallback path when Get-UjDefaultBackupFolder unavailable
      $null = $_
    }
    try {
      if (Test-UjIsAdministrator) {
        $lblAdmin.Text = 'Running as Administrator.'
        $lblAdmin.ForeColor = [System.Drawing.Color]::DarkGreen
      } else {
        $lblAdmin.Text = 'Not running as Administrator. Apply/Backup/Restore/Reset may fail.'
        $lblAdmin.ForeColor = [System.Drawing.Color]::DarkRed
      }
    } catch {
      $lblAdmin.Text = 'Could not determine elevation.'
      $lblAdmin.ForeColor = [System.Drawing.Color]::Gray
    }
  } else {
    $lblAdmin.Text = 'Module not loaded. Run unavailable.'
    $lblAdmin.ForeColor = [System.Drawing.Color]::DarkRed
    [System.Windows.Forms.MessageBox]::Show(
      "Could not load module. Ensure WindowsUdpJitterOptimization is next to this script.",
      'Error',
      [System.Windows.Forms.MessageBoxButtons]::OK,
      [System.Windows.Forms.MessageBoxIcon]::Warning
    )
  }

  Get-UjControlState
})

$comboAction.Add_SelectedIndexChanged({ Get-UjControlState })
$chkIncludeAppPolicies.Add_CheckedChanged({ Get-UjControlState })

$btnBrowse.Add_Click({
  $dialog = New-Object System.Windows.Forms.FolderBrowserDialog
  $dialog.Description = 'Select backup folder'
  $dialog.SelectedPath = $txtBackup.Text
  if ($dialog.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {
    $txtBackup.Text = $dialog.SelectedPath
  }
})

$btnRun.Add_Click({
  if ($script:IsRunInProgress) {
    return
  }

  if (-not (Import-UjModuleOnce)) {
    [System.Windows.Forms.MessageBox]::Show('Module not loaded. Cannot run.', 'Error', [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Error)
    return
  }

  $action = $comboAction.SelectedItem.ToString()
  if ($action -in @('Restore', 'ResetDefaults')) {
    $confirm = [System.Windows.Forms.MessageBox]::Show(
      "Really run $action? This will change system settings.",
      'Confirm',
      [System.Windows.Forms.MessageBoxButtons]::YesNo,
      [System.Windows.Forms.MessageBoxIcon]::Question
    )
    if ($confirm -ne [System.Windows.Forms.DialogResult]::Yes) {
      return
    }
  }

  $resolved = Resolve-UjGuiRunParameter
  if (-not $resolved.IsValid) {
    return
  }

  $params = $resolved.Params
  $preset = $resolved.Preset
  $phase = if ($resolved.Action -eq 'ResetDefaults') { 'Reset' } else { $resolved.Action }

  $script:IsRunInProgress = $true
  $btnRun.Enabled = $false
  $txtLog.Clear()
  Add-UjGuiLog -Phase 'Validate' -Message 'Inputs validated.'
  Add-UjGuiLog -Phase $phase -Message ("Running action (Preset {0})." -f $preset)

  try {
    $InformationPreference = 'Continue'
    $output = Invoke-UdpJitterOptimization @params 6>&1 3>&1
    foreach ($line in @($output)) {
      Add-UjGuiLog -Phase 'Output' -Message ([string]$line)
    }
    Add-UjGuiLog -Phase 'Done' -Message 'Completed.'
  } catch {
    Add-UjGuiLog -Phase 'Error' -Message $_.Exception.Message
    if ($_.ScriptStackTrace) {
      Add-UjGuiLog -Phase 'Error' -Message $_.ScriptStackTrace
    }
  } finally {
    $script:IsRunInProgress = $false
    $btnRun.Enabled = $true
  }
})

[void]$form.ShowDialog()
